<!DOCTYPE html>
<html>
<head>
 <link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
 <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>
 <link rel="stylesheet" href= "../CSS/Spatial_Query.css"/>
  <link rel="stylesheet" href= "../CSS/leaflet.draw.css"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="../Javascript/Spatial_Query.js"></script>
  <script src = "../Javascript/leaflet.draw.js"></script>
    <script src="../Javascript/Leaflet.MakiMarkers.js"></script>

</head>

<body bgcolor = "#e5f1fd" onload = "populateYearSelector()">
</div>

<div id = 'title'>BANDO-QUERY</div>

<div id = 'buttons'>
<button id = "deleteRectangle" onclick = "deleteRectangle()">Delete Rectangle</button>
<button id = "submitQuery" onclick = "submitQuery(tempRectangleArray[rectangleCount-1])"> Submit Query</button>
</div>

 <div class="dropdown">
  <button onclick="openDropdown('spatialQueryDropdownContent')" class="dropbtn" id = "spatialQueryDropdown">Spatial Query Options</button>
  <div id="spatialQueryDropdownContent" class="dropdown-content">
    <button id = "intersects" onclick = "spatialQueryOptions(this.id)">Intersects &#10004</button>
    <button id = "contains" onclick = "spatialQueryOptions(this.id)">Contains</button>
    <button id = "containsCentroid" onclick = "spatialQueryOptions(this.id)">Contains Centroid</button>
  </div>
</div>

 <div class="dropdown">
  <button onclick="openDropdown('dateDropdownContent')" class="dropbtn" id = "dateQueryDropdown">Date Options</button>
  <div id="dateDropdownContent" class="dropdown-content">
	<button id = "allYears" onclick = "dateQueryOptions(this.id)">All Years &#10004</button>
    <button id = "before" onclick = "dateQueryOptions(this.id)">Before</button>
    <button id = "during" onclick = "dateQueryOptions(this.id)">During</button>
    <button id = "after" onclick = "dateQueryOptions(this.id)">After</button>
  </div>
  
<select name="year" id = "year" onchange = "dateQueryOptions(dateQuerySelection)">
	<option> - Year - </option>
</select>

</div>

<div id="mapId">
<script>
var map = L.map('mapId', {geometryControl: true}).setView([27.73725068372226, -97.43062019348145], 12);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoieHVhbjI3IiwiYSI6IktzT0hVNjAifQ.v97O2GRYRJ8ZxhLHtTn30g', {
			maxZoom: 18,
			attribution: 'TAMUCC CartoCesna',
			id: 'mapbox.streets'
		}).addTo(map);
		
	Maki_Icon = tempIcon = L.MakiMarkers.icon({color: "#33c1ff", size: "m"});

	var markerCount = 0; // number of markers currently placed on slippy map
	var rectangleCount = 0; // number of rectangles currently placed on the slippy map
	var rectangleCoords = new Array(); // stores coordinates of created rectangles
	var tempRectangleArray = new Array(); // stores rectangle features 
	var tempMarkerArray = new Array(); // stores the marker features 

//Variable that contains the rectangle layer that will be modified with the draw control 
var drawItems = new L.FeatureGroup();
map.addLayer(drawItems)
	
// Initialise the draw control and pass it the FeatureGroup of editable layers
var geometryControl = new L.Control.Draw({
	position: 'topleft',
    draw: {
        polyline: false,
        polygon: false,
		rectangle:{
			repeatMode: false,
			metric: false,
			shapeOptions:{color: '#9c96e0',
				weight: 2,
				fillOpacity: 0.5,
				lineCap: "square"}
		},
        circle: false,
        marker: false,
    },
    edit: false
});
	map.addControl(geometryControl);

//Draw control which disables the creation of geometry layers and only allows for editing.
var editControl =  new L.Control.Draw({
	draw:{rectangle: false,
		polyline: false,
		polygon: false,
		circle: false,
		marker: false,
	},
	edit: {
		featureGroup: drawItems,
		remove: true
		}					
})

//Array that stores the amount of layers in the feature group.
Layer_Array = [];	

/*Event handler that is triggered when a new layer is created. A new element is pushed to the Layer Array, 
so to determine if a layer exists in the feature group. Therefore, if a layer exists, the draw control is 
removed and the edit control added. Also, if the layer type is a rectangle its bounds are obtained. Also a 
popup was included with the bound coordinates of the rectangle.*/
map.on("draw:created", function(e){
	var type = e.layerType, layer = e.layer;
	Layer_Array.push(layer)		
		if(Layer_Array.length >= 1){
			map.removeControl(geometryControl);
			map.addControl(editControl);
		}	
		
	if (type === "rectangle"){
		var Coords = layer.getBounds();
		NorthEastLng = Coords._northEast.lng;
		NorthEastLat = Coords._northEast.lat;
		SouthWestLng = Coords._southWest.lng;
		SouthWestLat = Coords._southWest.lat;
		console.log(Coords);
		layer.bindPopup("These are the Bounds of the rectangle </br> Norht East: </br>" + NorthEastLng + ", " + NorthEastLat + "</br> South West: </br>"+ SouthWestLng +", " + SouthWestLat);			
	}
	drawItems.addLayer(layer);
});

/*Event that occurs when a layers has been deleted and saved. The edit control panel is removed and the
geometry control is added.*/
map.on("draw:deleted", function(e){
	var Deleted_Layers = e.layers.getLayers();
			if (Deleted_Layers.length >= 1){
				map.removeControl(editControl)
				map.addControl(geometryControl);
			}				
		})
		
var NOthing = "";		
/*Event that obtains the coordinates of the rectangles, similar to when it is created, however this occurs after
the rectangle has been edited.*/
map.on('draw:edited', function (e) {
    var layers = e.layers;
    layers.eachLayer(function (layer) {
		layer.getBounds();
		var Coords = layer.getBounds();
			NorthEastLng = Coords._northEast.lng;
			NorthEastLat = Coords._northEast.lat;
			SouthWestLng = Coords._southWest.lng;
			SouthWestLat = Coords._southWest.lat;
			console.log(Coords);
			layer.bindPopup("These are the Bounds of the rectangle </br> Norht East: </br>" + NorthEastLng + ", " + NorthEastLat + "</br> South West: </br>"+ SouthWestLng +", " + SouthWestLat);
			
        //save back to db
    });
})
	
	function onMapClick(e) 
	{
		// proccesses that take place after first marker is placed 
		if(rectangleCount < 1)
		{
			//declares variables relevant to creating the active rectangle using markers 
			var coords = e.latlng;
			rectangleCoords.push(coords);
			var marker = L.marker(coords)
			marker.setIcon(tempIcon);
			map.addLayer(marker);
			tempMarkerArray.push(marker);
			markerCount++;
			
			//makes sure that the user doesnt place more than one active rectangle at a time
			if(markerCount % 2 == 0 )
			{
				//creates rectangle on slippy map and adds increments counters and pushes to appropriate arrays 
				rectangleCount++;
				var rectangle = L.rectangle([[rectangleCoords[markerCount-2].lat, rectangleCoords[markerCount-2].lng],
				[rectangleCoords[markerCount-1].lat, rectangleCoords[markerCount-1].lng]],{fillOpacity: .1, color: "#28afd5", weight: 2});
				map.addLayer(rectangle);
				tempRectangleArray.push(rectangle);
				
				//create JSON containing image coordinates of rectangle southwest and northeast corners
				//entryCoordinateObject = addEntryCoordinateObject(point1.x.toFixed(2), point1.y.toFixed(2), point2.x.toFixed(2), point2.y.toFixed(2));
	
			}
		}
		else
			alert("Can't place more than one rectangle at a time");
	}

	//Hadnel on right click functions TODO: MOVE THIS LATER
	map.on('contextmenu', onMapClick);
	
</script>

</div>

<div id = "results">
<h1 id = 'header'> RESULTS </h1>
<h1 id = 'subHeader'>  </h1>
<table id = "resultsTable">
	<tr>
		<td>
			File Name
		</td>	
		<td>
			Download Links:
		</td>
	</tr>
</table>

</div>

</body>
</html>